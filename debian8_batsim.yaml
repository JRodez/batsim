#==============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#==============================================================================
#
# DESCRIPTION: An applicance for batsim experimentation
#
#==============================================================================

---
## Choose one of them the following extends
checkpoint: btrfs.yaml
extend: default/chroot/debian8.yaml

#extend: default/virtualbox/debian8.yaml

#extend: default/qemu/debian8.yaml

global:
  virtualbox_memory_size: 2048
  qemu_memory_size : 2048
  appliance_formats: tar.gz qcow2 vdi
  appliance_tar_compression_level: fast
  btrfs_volume: "/"
  setup_packages: $$setup_packages git cmake build-essential e2fsprogs
  default_keyboard_layout: fr
  default_timezone: Europe/Paris
  root_password: root
  hostname: simctn
  simctn_dir: /root


bootstrap:
  - "@base"

setup:
  - "@base"
  - enable_root_login:
    - change_sshd_config:
      - exec_in: sed -i s/PermitRootLogin\ without-password/PermitRootLogin\ yes/ /etc/ssh/sshd_config
  - simgrid_install:
    - install dependencies:
      - exec_in: apt-get -y --force-yes install libboost-all-dev 2>&1
    - do_it:
      - exec_in: |
          mkdir -p $$simctn_dir
          cd $$simctn_dir
          git clone git://scm.gforge.inria.fr/simgrid/simgrid.git
      - exec_in: |
          cd $$simctn_dir/simgrid
          git checkout 8de23104635721196
          mkdir build
      - exec_in: |
          cd $$simctn_dir/simgrid/build
          cmake -DCMAKE_INSTALL_PREFIX=/usr/local/ -Denable_documentation=OFF ../
          make -j$(nproc)
          make install
  - batsim_install:
    - install dependencies:
      - exec_in: |
          apt-get -y --force-yes install \
          libboost-filesystem-dev \
          libboost-system-dev 2>&1
      # Install rapidjson (not available in jessy)
      - exec_in: |
          cd $$simctn_dir
          git clone https://github.com/miloyip/rapidjson.git
      - exec_in: |
          cd $$simctn_dir/rapidjson
          git checkout 3d5848a
          cp -a include/rapidjson /usr/include
    - do_it:
      - exec_in: |
          cd $$simctn_dir
          git clone https://scm.gforge.inria.fr/anonscm/git/batsim/batsim.git
      - exec_in: |
          cd $$simctn_dir/batsim
          git checkout 5a3ba6b
          mkdir build
      - exec_in: |
          cd $$simctn_dir/batsim/build
          cmake ..
          make -j$(nproc)
          #make install
  - fred_scheduler:
    - install dependencies:
      - exec_in: |
          apt-get -y --force-yes install \
          liblog-log4perl-perl \
          libjson-perl \
          liblist-moreutils-perl \
          libfile-slurp-perl \
          2>&1
    - get_it:
      - exec_in: |
          cd $$simctn_dir
          git clone https://github.com/wagnerf42/batch-simulator.git
      - exec_in: |
          cd $$simctn_dir/batch-simulator
          git checkout 170521bd1ec6
          cd ProcessorRange
          perl Makefile.PL
          make
          make install
          cd ..
          cp log4perl.conf.template log4perl.conf
  - oar_sched:
    - install dependencies:
      - exec_in: apt-get -y --force-yes install python3-pip 2>&1
    - install_oar_lib:
      - exec_in: |
          cd $$simctn_dir
          git clone https://github.com/oar-team/oar-lib.git
      - exec_in: |
          cd $$simctn_dir/oar-lib
          git checkout 840ac5e
          pip3 install -e .
    - install_oar_kao:
      - exec_in: |
          cd $$simctn_dir
          git clone https://github.com/oar-team/oar-kao.git
      - exec_in: |
          cd $$simctn_dir/oar-kao
          git checkout ae82dce
          pip3 install -e .
  - evalys:
    - install dependencies:
      - exec_in: |
          apt-get -y --force-yes install \
            python3-pip \
            python3-pyqt4 \
            python3-matplotlib \
            python3-pandas \
            ipython3-notebook 2>&1
    - install_evalys:
      - exec_in: |
          cd $$simctn_dir
          git clone https://github.com/oar-team/evalys.git
      - exec_in: |
          cd $$simctn_dir/evalys
          # Not stable for now
          #git checkout 840ac5e
          pip3 install -e .
  - import_experiment_material:
    - copy_platfom:
      - local2in:
        - $$kameleon_data_dir/griffon_modified.xml
        - $$simctn_dir/griffon_modified.xml
    - copy_job_description:
      - local2in:
        - $$kameleon_data_dir/300_16_0001000000.0_0000000000.0_010.json
        - $$simctn_dir/300_16_0001000000.0_0000000000.0_010.json
      - local2in:
        - $$kameleon_data_dir/CEA-Curie-2011-2.1-cln.swf
        - $$simctn_dir/CEA-Curie-2011-2.1-cln.swf
    - copy_experiment_script:
      - local2in:
        - $$kameleon_data_dir/experiment.py
        - $$simctn_dir/experiment.py
      - local2in:
        - $$kameleon_data_dir/swfToJsonConverter.py
        - $$simctn_dir/swfToJsonConverter.py
    - make_experiment_runnable:
      - exec_in: pip3 install sortedcontainers
      - exec_in: chmod 755 $$simctn_dir/experiment.py
      - exec_in: chmod 755 $$simctn_dir/swfToJsonConverter.py

export:
  - "@base"
